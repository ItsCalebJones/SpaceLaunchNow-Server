name: 🔄 Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  POETRY_HTTP_BASIC_TSD_USERNAME: ${{ secrets.PRIVATE_USERNAME }}
  POETRY_HTTP_BASIC_TSD_PASSWORD: ${{ secrets.PRIVATE_PASSWORD }}

jobs:
  update-dependencies:
    name: 🔄 Update Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 🐍 Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      - name: 🔄 Update Dependencies
        run: |
          # Update poetry.lock file with latest compatible versions
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            -e POETRY_HTTP_BASIC_TSD_USERNAME=${{ secrets.PRIVATE_USERNAME }} \
            -e POETRY_HTTP_BASIC_TSD_PASSWORD=${{ secrets.PRIVATE_PASSWORD }} \
            python:3.12-alpine sh -c "
              pip install poetry &&
              poetry config repositories.tsd https://pypi.thespacedevs.com/simple/ &&
              poetry config http-basic.tsd \$POETRY_HTTP_BASIC_TSD_USERNAME \$POETRY_HTTP_BASIC_TSD_PASSWORD &&
              poetry update
            "
          
      - name: 🔍 Debug Secrets (without exposing values)
        run: |
          echo "Checking if secrets are available..."
          if [ -z "${{ secrets.PRIVATE_USERNAME }}" ]; then
            echo "❌ PRIVATE_USERNAME secret is not set"
            echo "   This is REQUIRED for django-launch-library dependency"
            exit 1
          else
            echo "✅ PRIVATE_USERNAME secret is available"
          fi
          if [ -z "${{ secrets.PRIVATE_PASSWORD }}" ]; then
            echo "❌ PRIVATE_PASSWORD secret is not set"
            echo "   This is REQUIRED for django-launch-library dependency"
            exit 1
          else
            echo "✅ PRIVATE_PASSWORD secret is available"
          fi
          
      - name: 🏗️ Build Docker Image for Testing
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: test-image:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: |
            "private_username=${{ secrets.PRIVATE_USERNAME }}"
            "private_password=${{ secrets.PRIVATE_PASSWORD }}"
      
      - name: 🔍 Verify Docker Image Built Successfully
        run: |
          echo "Checking if test-image:latest was built successfully..."
          docker images test-image:latest
          if ! docker image inspect test-image:latest > /dev/null 2>&1; then
            echo "❌ ERROR: test-image:latest was not built successfully"
            echo "Available images:"
            docker images
            exit 1
          fi
          echo "✅ test-image:latest built successfully"
        
      - name: 🧪 Run Tests with Updated Dependencies
        run: |
          # Start database in background
          docker run -d --name test-db \
            -e POSTGRES_DB=postgres \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            postgres:14-alpine
          
          # Wait for database to be ready
          echo "⏳ Waiting for database to be ready..."
          sleep 10
          
          # Verify database is accessible
          if ! docker exec test-db pg_isready -U postgres; then
            echo "❌ Database is not ready"
            docker logs test-db
            exit 1
          fi
          echo "✅ Database is ready"
          
          # Run tests using our updated image
          echo "🧪 Running tests..."
          docker run --rm \
            --link test-db:db \
            -v "$(pwd)/report/coverage/:/code/coverage/" \
            -v "$(pwd)/report/htmlcov/:/code/htmlcov/" \
            -v "$(pwd)/report/xmlrunner/:/code/xmlrunner/" \
            -e DJANGO_SECRET_KEY=${{ secrets.PRIVATE_PASSWORD }} \
            -e DATABASE_NAME=postgres \
            -e DATABASE_USERNAME=postgres \
            -e DATABASE_PASSWORD=postgres \
            -e DATABASE_ENGINE=django.db.backends.postgresql \
            -e DATABASE_HOST=db \
            -e DATABASE_PORT=5432 \
            -e USE_LOCAL_STORAGE=true \
            test-image:latest \
            bash -c "coverage run --data-file=/code/coverage/.coverage manage.py test --settings=spacelaunchnow.settings.test && coverage html --data-file=/code/coverage/.coverage && coverage report --data-file=/code/coverage/.coverage"
          
          # Clean up database (always run, even if tests fail)
          echo "🧹 Cleaning up..."
          docker stop test-db && docker rm test-db || true
          
      - name: 📋 Generate Update Summary
        run: |
          # Compare lock files to see what changed
          git diff --name-only
          
          if git diff --quiet poetry.lock; then
            echo "No dependency updates available"
            echo "UPDATES_AVAILABLE=false" >> $GITHUB_ENV
          else
            echo "Dependencies updated"
            echo "UPDATES_AVAILABLE=true" >> $GITHUB_ENV
            
            # Generate a readable summary of package changes
            echo "## 📦 Package Updates" > package-summary.md
            echo "" >> package-summary.md
            
            # Extract package updates from poetry.lock diff with version info
            git diff poetry.lock > poetry-diff.txt
            
            # Parse updated packages with version changes
            echo "### Updated Packages:" >> package-summary.md
            
            # Create temporary files for processing
            grep -E "^\-.*name = " poetry-diff.txt | sed 's/^-.*name = "\(.*\)"/\1/' | sort > removed-packages.txt
            grep -E "^\+.*name = " poetry-diff.txt | sed 's/^+.*name = "\(.*\)"/\1/' | sort > added-packages.txt
            
            # Find packages that appear in both (updates) vs new/removed
            comm -12 removed-packages.txt added-packages.txt > updated-packages.txt
            comm -23 added-packages.txt removed-packages.txt > new-packages.txt
            comm -23 removed-packages.txt added-packages.txt > removed-only-packages.txt
            
            # For each updated package, extract version info
            if [ -s updated-packages.txt ]; then
              while IFS= read -r package; do
                old_version=$(grep -A 10 "^-.*name = \"$package\"" poetry-diff.txt | grep "^-version = " | head -1 | sed 's/^-version = "\(.*\)"/\1/')
                new_version=$(grep -A 10 "^+.*name = \"$package\"" poetry-diff.txt | grep "^+version = " | head -1 | sed 's/^+version = "\(.*\)"/\1/')
                if [ -n "$old_version" ] && [ -n "$new_version" ]; then
                  echo "- **$package**: $old_version → $new_version" >> package-summary.md
                else
                  echo "- **$package**: version updated" >> package-summary.md
                fi
              done < updated-packages.txt
            fi
            
            # List new packages
            if [ -s new-packages.txt ]; then
              echo "" >> package-summary.md
              echo "### New Packages:" >> package-summary.md
              while IFS= read -r package; do
                new_version=$(grep -A 10 "^+.*name = \"$package\"" poetry-diff.txt | grep "^+version = " | head -1 | sed 's/^+version = "\(.*\)"/\1/')
                if [ -n "$new_version" ]; then
                  echo "- **$package**: $new_version" >> package-summary.md
                else
                  echo "- **$package**: added" >> package-summary.md
                fi
              done < new-packages.txt
            fi
            
            # List removed packages
            if [ -s removed-only-packages.txt ]; then
              echo "" >> package-summary.md
              echo "### Removed Packages:" >> package-summary.md
              while IFS= read -r package; do
                old_version=$(grep -A 10 "^-.*name = \"$package\"" poetry-diff.txt | grep "^-version = " | head -1 | sed 's/^-version = "\(.*\)"/\1/')
                if [ -n "$old_version" ]; then
                  echo "- **$package**: $old_version" >> package-summary.md
                else
                  echo "- **$package**: removed" >> package-summary.md
                fi
              done < removed-only-packages.txt
            fi
            
            # If no packages were found, add fallback message
            if [ ! -s updated-packages.txt ] && [ ! -s new-packages.txt ] && [ ! -s removed-only-packages.txt ]; then
              echo "- No package changes detected" >> package-summary.md
            fi
            
            echo "" >> package-summary.md
            echo "### Statistics:" >> package-summary.md
            ADDED=$(git diff poetry.lock --numstat | awk '{print $1}')
            REMOVED=$(git diff poetry.lock --numstat | awk '{print $2}')
            echo "- Lines added: $ADDED" >> package-summary.md
            echo "- Lines removed: $REMOVED" >> package-summary.md
            
            # Store summary for PR body
            echo "PACKAGE_SUMMARY<<EOF" >> $GITHUB_ENV
            cat package-summary.md >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Clean up temporary files (don't commit them)
            rm -f poetry-diff.txt removed-packages.txt added-packages.txt updated-packages.txt new-packages.txt removed-only-packages.txt package-summary.md
          fi
          
      - name: 🧹 Clean Working Directory  
        if: env.UPDATES_AVAILABLE == 'true'
        run: |
          # Ensure only poetry.lock is staged for commit
          git add poetry.lock
          # Remove any other generated files from staging
          git reset HEAD -- dependency-changes.diff 2>/dev/null || true
          git rm --cached dependency-changes.diff 2>/dev/null || true
          rm -f dependency-changes.diff
          
      - name: 📤 Create Pull Request
        id: create-pr
        if: env.UPDATES_AVAILABLE == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            🔄 Update Python dependencies
            
            Automated dependency update via scheduled workflow.
          title: '🔄 Weekly Dependency Updates'
          body: |
            ## 🔄 Automated Dependency Updates
            
            This PR contains automated updates to Python dependencies.
            
            ${{ env.PACKAGE_SUMMARY }}
            
            ### ✅ Automated Checks Passed:
            - Unit tests
            - Security scan
            - Lock file validation
            
            ### 📋 Review Checklist:
            - [ ] Review changelog for breaking changes
            - [ ] Test staging deployment
            - [ ] Monitor application logs
            
            **Generated by:** Weekly dependency update workflow
            **Timestamp:** ${{ github.run_started_at }}
          branch: automated/dependency-updates
          delete-branch: true
          
      - name: 📢 Notify on Discord
        if: env.UPDATES_AVAILABLE == 'true' && steps.create-pr.outputs.pull-request-number
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            🔄 **Dependency Updates Available**
            
            New PR #${{ steps.create-pr.outputs.pull-request-number }} created with updated Python dependencies.
            Please review and merge if tests pass.
            
            🔗 **Direct Link:** ${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.create-pr.outputs.pull-request-number }}
            📊 **All PRs:** ${{ github.server_url }}/${{ github.repository }}/pulls
