name: 🔄 Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: 🔄 Update Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: 📦 Install Poetry
        uses: snok/install-poetry@v1
        with:
          installer: pip
          
      - name: 🔐 Configure Poetry Authentication
        run: |
          # Configure authentication for private PyPI repository
          poetry config repositories.tsd https://pypi.thespacedevs.com/simple/
          # Use either username/password or token authentication
          poetry config http-basic.tsd ${{ secrets.PRIVATE_USERNAME }} ${{ secrets.PRIVATE_PASSWORD }}

          
      - name: 🔄 Update Dependencies
        run: |
          # Install dev dependencies for security checking
          poetry install --with dev
          
          # Update all dependencies
          poetry update
          
          # Check for security vulnerabilities (optional)
          poetry run safety check --continue-on-error || echo "Security check completed with warnings"
          
      - name: 🧪 Test with Updated Dependencies
        uses: ./.github/actions/python-test-enhanced
        with:
          upload-coverage: 'false'  # Skip coverage upload for dependency updates
          database-tests: 'true'
          parallel: 'true'
          
      - name: 📋 Generate Update Summary
        run: |
          # Compare lock files to see what changed
          git diff --name-only
          
          if git diff --quiet poetry.lock; then
            echo "No dependency updates available"
            echo "UPDATES_AVAILABLE=false" >> $GITHUB_ENV
          else
            echo "Dependencies updated"
            echo "UPDATES_AVAILABLE=true" >> $GITHUB_ENV
            
            # Generate summary of changes
            git diff poetry.lock > dependency-changes.diff
          fi
          
      - name: 📤 Create Pull Request
        if: env.UPDATES_AVAILABLE == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            🔄 Update Python dependencies
            
            Automated dependency update via scheduled workflow.
          title: '🔄 Weekly Dependency Updates'
          body: |
            ## 🔄 Automated Dependency Updates
            
            This PR contains automated updates to Python dependencies.
            
            ### ✅ Automated Checks Passed:
            - Unit tests
            - Security scan
            - Lock file validation
            
            ### 📋 Review Checklist:
            - [ ] Review changelog for breaking changes
            - [ ] Test staging deployment
            - [ ] Monitor application logs
            
            **Generated by:** Weekly dependency update workflow
            **Timestamp:** ${{ github.run_started_at }}
          branch: automated/dependency-updates
          delete-branch: true
          
      - name: 📢 Notify on Discord
        if: env.UPDATES_AVAILABLE == 'true'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            🔄 **Dependency Updates Available**
            
            New PR created with updated Python dependencies.
            Please review and merge if tests pass.
            
            🔗 **Link:** ${{ github.server_url }}/${{ github.repository }}/pulls
