name: 🔄 Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  POETRY_HTTP_BASIC_TSD_USERNAME: ${{ secrets.PRIVATE_USERNAME }}
  POETRY_HTTP_BASIC_TSD_PASSWORD: ${{ secrets.PRIVATE_PASSWORD }}

jobs:
  update-dependencies:
    name: 🔄 Update Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 🐍 Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      - name: 🔄 Update Dependencies
        run: |
          # Capture current package versions before update
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            -e POETRY_HTTP_BASIC_TSD_USERNAME=${{ secrets.PRIVATE_USERNAME }} \
            -e POETRY_HTTP_BASIC_TSD_PASSWORD=${{ secrets.PRIVATE_PASSWORD }} \
            python:3.12-alpine sh -c "
              pip install poetry &&
              poetry config repositories.tsd https://pypi.thespacedevs.com/simple/ &&
              poetry config http-basic.tsd \$POETRY_HTTP_BASIC_TSD_USERNAME \$POETRY_HTTP_BASIC_TSD_PASSWORD &&
              poetry show --outdated > before-update.txt 2>/dev/null || echo 'No outdated packages' > before-update.txt &&
              poetry show > before-all-packages.txt &&
              poetry update &&
              poetry show > after-update.txt &&
              poetry show --outdated > after-outdated.txt 2>/dev/null || echo 'No outdated packages' > after-outdated.txt
            "
          
          # Keep the text files for package comparison later
          echo "📊 Package update files generated"
          
      - name: 🔍 Debug Secrets (without exposing values)
        run: |
          echo "Checking if secrets are available..."
          if [ -z "${{ secrets.PRIVATE_USERNAME }}" ]; then
            echo "❌ PRIVATE_USERNAME secret is not set"
            echo "   This is REQUIRED for django-launch-library dependency"
            exit 1
          else
            echo "✅ PRIVATE_USERNAME secret is available"
          fi
          if [ -z "${{ secrets.PRIVATE_PASSWORD }}" ]; then
            echo "❌ PRIVATE_PASSWORD secret is not set"
            echo "   This is REQUIRED for django-launch-library dependency"
            exit 1
          else
            echo "✅ PRIVATE_PASSWORD secret is available"
          fi
          
      - name: 🏗️ Build Docker Image for Testing
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: test-image:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: |
            "private_username=${{ secrets.PRIVATE_USERNAME }}"
            "private_password=${{ secrets.PRIVATE_PASSWORD }}"
      
      - name: 🔍 Verify Docker Image Built Successfully
        run: |
          echo "Checking if test-image:latest was built successfully..."
          docker images test-image:latest
          if ! docker image inspect test-image:latest > /dev/null 2>&1; then
            echo "❌ ERROR: test-image:latest was not built successfully"
            echo "Available images:"
            docker images
            exit 1
          fi
          echo "✅ test-image:latest built successfully"
        
      - name: 🧪 Run Tests with Updated Dependencies
        run: |
          # Start database in background
          docker run -d --name test-db \
            -e POSTGRES_DB=postgres \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            postgres:14-alpine
          
          # Wait for database to be ready
          echo "⏳ Waiting for database to be ready..."
          sleep 10
          
          # Verify database is accessible
          if ! docker exec test-db pg_isready -U postgres; then
            echo "❌ Database is not ready"
            docker logs test-db
            exit 1
          fi
          echo "✅ Database is ready"
          
          # Run tests using our updated image
          echo "🧪 Running tests..."
          docker run --rm \
            --link test-db:db \
            -v "$(pwd)/report/coverage/:/code/coverage/" \
            -v "$(pwd)/report/htmlcov/:/code/htmlcov/" \
            -v "$(pwd)/report/xmlrunner/:/code/xmlrunner/" \
            -e DJANGO_SECRET_KEY=${{ secrets.PRIVATE_PASSWORD }} \
            -e DATABASE_NAME=postgres \
            -e DATABASE_USERNAME=postgres \
            -e DATABASE_PASSWORD=postgres \
            -e DATABASE_ENGINE=django.db.backends.postgresql \
            -e DATABASE_HOST=db \
            -e DATABASE_PORT=5432 \
            -e USE_LOCAL_STORAGE=true \
            test-image:latest \
            bash -c "coverage run --data-file=/code/coverage/.coverage manage.py test --settings=spacelaunchnow.settings.test && coverage html --data-file=/code/coverage/.coverage && coverage report --data-file=/code/coverage/.coverage"
          
          # Clean up database (always run, even if tests fail)
          echo "🧹 Cleaning up..."
          docker stop test-db && docker rm test-db || true
          
      - name: 📋 Generate Update Summary
        run: |
          # Compare lock files to see what changed
          git diff --name-only
          
          if git diff --quiet poetry.lock; then
            echo "No dependency updates available"
            echo "UPDATES_AVAILABLE=false" >> $GITHUB_ENV
          else
            echo "Dependencies updated"
            echo "UPDATES_AVAILABLE=true" >> $GITHUB_ENV
            
            # Generate a readable summary of package changes
            echo "## 📦 Package Updates" > package-summary.md
            echo "" >> package-summary.md
            
            # Check if we have text files from poetry show commands
            if [ -f "before-all-packages.txt" ] && [ -f "after-update.txt" ] && [ -f "before-update.txt" ]; then
              echo "🔍 Using poetry show data to detect specific package changes..."
              
              # Use our Python script to parse package differences
              if [ -f ".github/scripts/parse-package-updates.py" ]; then
                python3 .github/scripts/parse-package-updates.py before-all-packages.txt after-update.txt before-update.txt >> package-summary.md
              else
                echo "### Updated Packages:" >> package-summary.md
                BEFORE_COUNT=$(wc -l < before-all-packages.txt)
                AFTER_COUNT=$(wc -l < after-update.txt)
                echo "- $AFTER_COUNT packages checked for updates" >> package-summary.md
                echo "- Poetry dependency resolution completed successfully" >> package-summary.md
              fi
              
              # Clean up text files
              rm -f before-all-packages.txt after-update.txt before-update.txt after-outdated.txt
            else
              echo "🔍 Using git diff to detect changes (text files not available)..."
              echo "### Updated Packages:" >> package-summary.md
              echo "- Package metadata or constraints updated" >> package-summary.md
            fi
            
            echo "" >> package-summary.md
            echo "### Statistics:" >> package-summary.md
            STATS=$(git diff --numstat poetry.lock)
            if [ -n "$STATS" ]; then
              ADDED=$(echo "$STATS" | awk '{print $1}')
              REMOVED=$(echo "$STATS" | awk '{print $2}')
              echo "- Lines added: $ADDED" >> package-summary.md
              echo "- Lines removed: $REMOVED" >> package-summary.md
            else
              echo "- No changes to poetry.lock file" >> package-summary.md
            fi
            
            # Store summary for PR body
            echo "PACKAGE_SUMMARY<<EOF" >> $GITHUB_ENV
            cat package-summary.md >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # Clean up temporary files (don't commit them)
            rm -f package-summary.md
          fi
          
      - name: 🧹 Clean Working Directory  
        if: env.UPDATES_AVAILABLE == 'true'
        run: |
          # Ensure only poetry.lock is staged for commit
          git add poetry.lock
          # Remove any other generated files from staging and working directory
          rm -f before-all-packages.txt after-update.txt before-update.txt after-outdated.txt package-summary.md
          git reset HEAD -- dependency-changes.diff package-changes.txt old-poetry.lock before-all-packages.txt after-update.txt before-update.txt after-outdated.txt 2>/dev/null || true
          git clean -f -d
          
      - name: 📤 Create Pull Request
        id: create-pr
        if: env.UPDATES_AVAILABLE == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            🔄 Update Python dependencies
            
            Automated dependency update via scheduled workflow.
          title: '🔄 Weekly Dependency Updates'
          body: |
            ## 🔄 Automated Dependency Updates
            
            This PR contains automated updates to Python dependencies.
            
            ${{ env.PACKAGE_SUMMARY }}
            
            ### ✅ Automated Checks Passed:
            - Unit tests
            - Security scan
            - Lock file validation
            
            ### 📋 Review Checklist:
            - [ ] Review changelog for breaking changes
            - [ ] Test staging deployment
            - [ ] Monitor application logs
            
            **Generated by:** Weekly dependency update workflow
            **Timestamp:** ${{ github.run_started_at }}
          branch: automated/dependency-updates
          delete-branch: true
          
      - name: 📢 Notify on Discord
        if: env.UPDATES_AVAILABLE == 'true' && steps.create-pr.outputs.pull-request-number
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            🔄 **Dependency Updates Available**
            
            New PR #${{ steps.create-pr.outputs.pull-request-number }} created with updated Python dependencies.
            Please review and merge if tests pass.
            
            🔗 **Direct Link:** ${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.create-pr.outputs.pull-request-number }}
            📊 **All PRs:** ${{ github.server_url }}/${{ github.repository }}/pulls
