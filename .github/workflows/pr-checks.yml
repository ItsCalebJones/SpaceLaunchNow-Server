name: ğŸ” Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened, ready_for_review]

# Cancel previous runs if a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: registry.digitalocean.com/sln-prod-registry-01
  IMAGE_NAME: space-launch-now-base

jobs:
  # ========================================
  # ğŸ” FAST LINTING (No Docker/Poetry overhead)
  # ========================================
  
  lint:
    name: ğŸ” Fast Linting
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
        
      - name: ğŸ“¦ Install Ruff
        run: |
          python -m pip install --upgrade pip
            pip install ruff==0.9.1
        
      - name: ğŸ” Run Ruff Linting
        run: |
          echo "::group::ğŸ” Ruff Check"
          ruff check src/ --output-format=github
          echo "::endgroup::"
          
          echo "::group::ğŸ¨ Ruff Format Check"
          ruff format --check src/
          echo "::endgroup::"
        
      - name: ğŸ“Š Generate Lint Report
        if: always()
        run: |
          echo "::group::ğŸ“Š Lint Summary"
          echo "Generating detailed lint report..."
          ruff check src/ --output-format=json > lint-report.json || true
          echo "::endgroup::"
        
      - name: ğŸ“¤ Upload Lint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.json
          retention-days: 7

  # ========================================
  # ğŸ—ï¸ BUILD ONCE (Reuse for tests and security)
  # ========================================
  
  build:
    name: ğŸ—ï¸ Build Docker Image
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      image-name: ${{ steps.image.outputs.image-name }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ—ï¸ Build Docker Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: test-image:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/test-image.tar
          build-args: |
            PRIVATE_USERNAME=${{ secrets.PRIVATE_USERNAME }}
            PRIVATE_PASSWORD=${{ secrets.PRIVATE_PASSWORD }}
            
      - name: ğŸ“¤ Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: test-image
          path: /tmp/test-image.tar
          retention-days: 1
          
      - name: ğŸ·ï¸ Set Image Name
        id: image
        run: echo "image-name=test-image:${{ github.sha }}" >> $GITHUB_OUTPUT

  # ========================================
  # ğŸ§ª TESTS (Reuse built image)
  # ========================================
  
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ“¥ Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: test-image
          path: /tmp
          
      - name: ğŸ”„ Load Docker Image
        run: |
          docker load --input /tmp/test-image.tar
          docker tag ${{ needs.build.outputs.image-name }} test-image:latest
        
      - name: ğŸ§ª Run Tests
        run: |
          # Override the image in docker-compose to use our built image
          COMPOSE_FILE="docker/docker-compose.test.yml"
          
          # Create a temporary compose file with our built image
          cat > docker-compose.test.override.yml << EOF
          version: '3.8'
          services:
            test:
              image: test-image:latest
          EOF
          
          docker compose -f $COMPOSE_FILE -f docker-compose.test.override.yml run --rm test
          
      - name: ğŸ“Š Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: report/

  # ========================================
  # ğŸ”’ SECURITY SCAN (Reuse built image)
  # ========================================
  
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: test-image
          path: /tmp
          
      - name: ğŸ”„ Load Docker Image
        run: |
          docker load --input /tmp/test-image.tar
        
      - name: ğŸ” Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build.outputs.image-name }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“‹ Upload Security Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: ğŸ”’ Run Bandit Security Scan (Source Code)
        run: |
          # Quick source code security scan without Poetry overhead
          pip install bandit[toml]
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt
        continue-on-error: true
        
      - name: ğŸ“¤ Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 7

  # ========================================
  # ğŸ“‹ QUALITY SUMMARY
  # ========================================
  
  quality-gate:
    name: ğŸ“‹ Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“Š Check Quality Gate
        run: |
          echo "::group::ğŸ“‹ Quality Gate Results"
          
          LINT_STATUS="${{ needs.lint.result }}"
          TEST_STATUS="${{ needs.test.result }}"
          SECURITY_STATUS="${{ needs.security.result }}"
          
          echo "ğŸ” Linting: $LINT_STATUS"
          echo "ğŸ§ª Testing: $TEST_STATUS"
          echo "ğŸ”’ Security: $SECURITY_STATUS"
          
          # Determine overall status
          if [[ "$LINT_STATUS" == "success" && "$TEST_STATUS" == "success" && "$SECURITY_STATUS" == "success" ]]; then
            echo "âœ… Quality gate PASSED - All checks successful!"
            echo "quality_gate=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Quality gate FAILED - Some checks failed"
            echo "quality_gate=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "::endgroup::"
        
      - name: ğŸ’¬ Comment PR Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Find existing bot comment
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ” Quality Check Results')
            );
            
            const lintStatus = '${{ needs.lint.result }}';
            const testStatus = '${{ needs.test.result }}';
            const securityStatus = '${{ needs.security.result }}';
            
            const getStatusIcon = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¸ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };
            
            const body = `## ğŸ” Quality Check Results
            
            | Check | Status | Result |
            |-------|--------|--------|
            | ğŸ” **Linting** | ${getStatusIcon(lintStatus)} | ${lintStatus} |
            | ğŸ§ª **Testing** | ${getStatusIcon(testStatus)} | ${testStatus} |
            | ğŸ”’ **Security** | ${getStatusIcon(securityStatus)} | ${securityStatus} |
            
            ${lintStatus === 'success' && testStatus === 'success' && securityStatus === 'success'
              ? 'ğŸ‰ **All quality checks passed!** This PR is ready for review.' 
              : 'âš ï¸ **Some quality checks failed.** Please review the failed checks above.'}
            
            ---
            <sub>âš¡ Optimized pipeline: Fast linting + single Docker build reused for tests & security</sub>
            <sub>Triggered by commit ${context.sha.substring(0, 7)} â€¢ [View Details](${context.payload.pull_request.html_url}/checks)</sub>`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ========================================
  # ğŸš« BLOCK MERGE ON FAILURE
  # ========================================
  
  block-merge:
    name: ğŸš« Block Merge on Failure
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: failure()
    
    steps:
      - name: ğŸš« Block Merge
        run: |
          echo "::error::Quality gate failed - blocking merge"
          echo "Please fix the failing checks before merging this PR"
          exit 1
