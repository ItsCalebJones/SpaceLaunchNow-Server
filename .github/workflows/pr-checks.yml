name: ğŸ” Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened, ready_for_review]

# Cancel previous runs if a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  POETRY_HTTP_BASIC_TSD_USERNAME: ${{ secrets.PRIVATE_USERNAME }}
  POETRY_HTTP_BASIC_TSD_PASSWORD: ${{ secrets.PRIVATE_PASSWORD }}

jobs:
  # ========================================
  # ğŸ” LINTING & CODE QUALITY
  # ========================================
  
  lint:
    name: ğŸ” Code Linting
    runs-on: ubuntu-latest
    # Skip draft PRs unless they're marked as ready for review
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          # Fetch full history for better analysis
          fetch-depth: 0
        
      - name: ï¿½ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
        
      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: '2.1.3'
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
        
      - name: ğŸ”§ Load Cached Virtual Environment
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
        
      - name: ï¿½ğŸ“¦ Install Dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: |
          # Configure Poetry for private repository access
          poetry config http-basic.tsd ${{ secrets.PRIVATE_USERNAME }} ${{ secrets.PRIVATE_PASSWORD }}
          poetry install --all-extras --with dev
        
      - name: ğŸ” Run Ruff Linting
        run: |
          echo "::group::ğŸ” Ruff Check"
          poetry run ruff check src/ --output-format=github
          echo "::endgroup::"
          
          echo "::group::ğŸ¨ Ruff Format Check"
          poetry run ruff format --check src/
          echo "::endgroup::"
        
      - name: ğŸ“Š Generate Lint Report
        if: always()
        run: |
          echo "::group::ğŸ“Š Lint Summary"
          echo "Generating detailed lint report..."
          poetry run ruff check src/ --output-format=json > lint-report.json || true
          echo "::endgroup::"
        
      - name: ğŸ“¤ Upload Lint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.json
          retention-days: 7

  # ========================================
  # ğŸ§ª PYTEST TESTING
  # ========================================
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ§ª Run Tests
        run: |
          docker compose -f docker/docker-compose.test.yml run --rm test
          
      - name: ğŸ“Š Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: report/

  # ========================================
  # ğŸ”’ SECURITY SCANNING
  # ========================================
  
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
        
      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: '2.1.3'
        
      - name: ğŸ”’ Run Bandit Security Scan
        run: |
          # Configure Poetry for private repository access
          poetry config http-basic.tsd ${{ secrets.PRIVATE_USERNAME }} ${{ secrets.PRIVATE_PASSWORD }}
          poetry add bandit[toml] --group dev
          poetry run bandit -r src/ -f json -o bandit-report.json || true
          poetry run bandit -r src/ -f txt
        continue-on-error: true
        
      - name: ğŸ“¤ Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 7

  # ========================================
  # ğŸ“¦ BUILD TEST
  # ========================================
  
  build-test:
    name: ğŸ³ Build Test
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”¨ Test Docker Build
        run: |
          echo "::group::ğŸ³ Building Docker Image"
          docker build \
            --build-arg PRIVATE_USERNAME=${{ secrets.PRIVATE_USERNAME }} \
            --build-arg PRIVATE_PASSWORD=${{ secrets.PRIVATE_PASSWORD }} \
            --tag test-build:${{ github.sha }} \
            .
          echo "::endgroup::"
          
          echo "::group::ğŸ” Image Information"
          docker images test-build:${{ github.sha }}
          docker history test-build:${{ github.sha }}
          echo "::endgroup::"

  # ========================================
  # ğŸ“‹ QUALITY SUMMARY
  # ========================================
  
  quality-gate:
    name: ğŸ“‹ Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, test, security, build-test]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“Š Check Quality Gate
        run: |
          echo "::group::ğŸ“‹ Quality Gate Results"
          
          LINT_STATUS="${{ needs.lint.result }}"
          TEST_STATUS="${{ needs.test.result }}"
          SECURITY_STATUS="${{ needs.security.result }}"
          BUILD_STATUS="${{ needs.build-test.result }}"
          
          echo "ğŸ” Linting: $LINT_STATUS"
          echo "ğŸ§ª Testing: $TEST_STATUS"
          echo "ğŸ”’ Security: $SECURITY_STATUS"
          echo "ğŸ³ Build: $BUILD_STATUS"
          
          # Determine overall status
          if [[ "$LINT_STATUS" == "success" && "$TEST_STATUS" == "success" && "$BUILD_STATUS" == "success" ]]; then
            echo "âœ… Quality gate PASSED - All checks successful!"
            echo "quality_gate=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Quality gate FAILED - Some checks failed"
            echo "quality_gate=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "::endgroup::"
        
      - name: ğŸ’¬ Comment PR Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Find existing bot comment
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ” Quality Check Results')
            );
            
            const lintStatus = '${{ needs.lint.result }}';
            const testStatus = '${{ needs.test.result }}';
            const securityStatus = '${{ needs.security.result }}';
            const buildStatus = '${{ needs.build-test.result }}';
            
            const getStatusIcon = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¸ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };
            
            const body = `## ğŸ” Quality Check Results
            
            | Check | Status | Result |
            |-------|--------|--------|
            | ğŸ” **Linting** | ${getStatusIcon(lintStatus)} | ${lintStatus} |
            | ğŸ§ª **Testing** | ${getStatusIcon(testStatus)} | ${testStatus} |
            | ğŸ”’ **Security** | ${getStatusIcon(securityStatus)} | ${securityStatus} |
            | ğŸ³ **Build** | ${getStatusIcon(buildStatus)} | ${buildStatus} |
            
            ${lintStatus === 'success' && testStatus === 'success' && buildStatus === 'success' 
              ? 'ğŸ‰ **All quality checks passed!** This PR is ready for review.' 
              : 'âš ï¸ **Some quality checks failed.** Please review the failed checks above.'}
            
            ---
            <sub>Triggered by commit ${context.sha.substring(0, 7)} â€¢ [View Details](${context.payload.pull_request.html_url}/checks)</sub>`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ========================================
  # ğŸš« BLOCK MERGE ON FAILURE
  # ========================================
  
  block-merge:
    name: ğŸš« Block Merge on Failure
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: failure()
    
    steps:
      - name: ğŸš« Block Merge
        run: |
          echo "::error::Quality gate failed - blocking merge"
          echo "Please fix the failing checks before merging this PR"
          exit 1
