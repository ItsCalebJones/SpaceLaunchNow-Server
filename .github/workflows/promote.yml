name: ğŸ¯ Promote to Production

on:
  workflow_dispatch:
    inputs:
      staging_tag:
        description: 'Staging tag to promote (e.g., develop-abc123)'
        required: true
        type: string
      release_version:
        description: 'Release version (e.g., v2024.01.15)'
        required: false
        type: string

env:
  REGISTRY: registry.digitalocean.com/sln-prod-registry-01
  IMAGE_NAME: space-launch-now-base

jobs:
  validate:
    name: ğŸ” Validate Staging Image
    runs-on: ubuntu-latest
    outputs:
      staging-tag: ${{ github.event.inputs.staging_tag }}
      release-version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: ğŸ”§ Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN_SLN }}
          
      - name: ğŸ” Login to Registry
        run: doctl registry login --expiry-seconds 3600
        
      - name: ğŸ” Validate Staging Image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.staging_tag }}"
          echo "ğŸ” Validating staging image: $IMAGE"
          
          if ! docker manifest inspect "$IMAGE" >/dev/null 2>&1; then
            echo "âŒ Staging image does not exist: $IMAGE"
            exit 1
          fi
          
          echo "âœ… Staging image validated"
          
      - name: ğŸ·ï¸ Generate Release Version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.release_version }}" ]]; then
            VERSION="${{ github.event.inputs.release_version }}"
          else
            # Generate version based on date
            VERSION="v$(date +%Y.%m.%d)-$(date +%H%M)"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Release version: $VERSION"

  promote:
    name: ğŸš€ Promote Image
    runs-on: ubuntu-latest
    needs: [validate]
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_TOKEN }}
          
      - name: ğŸ”§ Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN_SLN }}
          
      - name: ğŸ” Login to Registry
        run: doctl registry login --expiry-seconds 3600
        
      - name: ğŸ·ï¸ Tag Production Image
        run: |
          STAGING_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.staging-tag }}"
          PROD_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.release-version }}"
          LATEST_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production"
          
          echo "ğŸ“¦ Pulling staging image: $STAGING_IMAGE"
          docker pull "$STAGING_IMAGE"
          
          echo "ğŸ·ï¸ Tagging as: $PROD_IMAGE"
          docker tag "$STAGING_IMAGE" "$PROD_IMAGE"
          
          echo "ğŸ·ï¸ Tagging as: $LATEST_IMAGE"
          docker tag "$STAGING_IMAGE" "$LATEST_IMAGE"
          
          echo "ğŸ“¤ Pushing production tags..."
          docker push "$PROD_IMAGE"
          docker push "$LATEST_IMAGE"
          
      - name: ğŸ”„ Update Production Manifests
        run: |
          cd manifests/apps/production
          
          # Update the image tag in kustomization
          sed -i "s|newTag:.*|newTag: ${{ needs.validate.outputs.release-version }}|" kustomization.yaml
          
          # Commit changes
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add kustomization.yaml
          git commit -m "ğŸš€ Promote ${{ needs.validate.outputs.staging-tag }} to production as ${{ needs.validate.outputs.release-version }}"
          git push

  notify:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [promote, validate]
    if: success()
    
    steps:
      - name: ğŸ“¢ Discord Notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ğŸ‰ **Production Promotion Successful!**
            
            **Staging Tag:** ${{ needs.validate.outputs.staging-tag }}
            **Production Version:** ${{ needs.validate.outputs.release-version }}
            **Promoted by:** ${{ github.actor }}
            
            ğŸ”— **ArgoCD:** https://argo.spacelaunchnow.app
